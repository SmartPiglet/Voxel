var Emoji_Picker={template:"#vxfeed__emoji-picker",emits:["select"],props:{composer:Object},data(){return{isOpen:!1,loading:!0,list:null,recents:[],search:{term:"",list:[]}}},methods:{open(){this.isOpen=!0,this.load()},load(){null===this.list&&jQuery.get(this.$root.config.settings.emojis.url).always(e=>{"object"!=typeof e?this.loading=!1:(this.loading=!1,this.list=e)});var e=localStorage.getItem("voxel:recent_emojis");"string"==typeof e&&(this.recents=[...e])},insert(t){this.$emit("select",t);let e=[];var s=localStorage.getItem("voxel:recent_emojis");(e=(e="string"==typeof s?[...s]:e).filter(e=>e!==t)).unshift(t),localStorage.setItem("voxel:recent_emojis",e.slice(0,16).join("")),this.recents=e.slice(0,16)},runSearch(){let t=[],s=!1;Object.values(this.list).forEach(e=>{s||e.forEach(e=>{s||-1!==e.name.toLowerCase().indexOf(this.search.term.trim().toLowerCase())&&(t.push(e.emoji),s=80<=t.length)})}),this.search.list=t}},watch:{"search.term"(){this.search.term.trim()&&this.list&&this.runSearch()}}},Composer_Mixin={components:{"emoji-picker":Emoji_Picker},data(){return{uniqueId:"vxfeed__composer-"+Voxel.helpers.sequentialId(),isFocused:!1,footerHeight:"",data:{content:"",files:[]},mentions:{show:!1,style:{top:null,left:null},caretOffset:null,query:{startIndex:null,endIndex:null,content:""},list:[],focused:0,lastRequest:null},refreshKey:0,isComposing:!1}},created(){this.queryMentions=Voxel.helpers.debounce(()=>{this.mentions.lastRequest?.abort();let t=this.mentions.query.content;this.mentions.lastRequest=jQuery.get(Voxel_Config.ajax_url+"&action=timeline/v2/mentions.search",{search:t,_wpnonce:this.$root.config.nonce}).always(e=>{e.success&&(this.mentions.list=e.users,this.mentions.focused=0,window._vx_mentions_cache[t]=e.users)})},200)},methods:{onInput(e){var t=this.$refs.textarea.selectionStart;"@"!==e.data||1!==t&&!/\s/.test(this.data.content[t-2])||(this.mentions.query.startIndex=t,this.mentions.query.endIndex=t,this.showMentions(t)),this.mentions.show&&(!(t>=this.mentions.query.startIndex&&t-this.mentions.query.startIndex<=32)||(this.mentions.query.endIndex=t,(e=this.data.content.substring(this.mentions.query.startIndex,t)).length&&!/^@[A-Za-z0-9._路@-]{1,63}$/g.test("@"+e))?this.hideMentions():2<=(this.mentions.query.content=e).length&&(Array.isArray(window._vx_mentions_cache[e])?(this.mentions.list=window._vx_mentions_cache[e],this.mentions.focused=0):this.queryMentions()))},onCompositionStart(){this.isComposing=!0},onCompositionUpdate(){requestAnimationFrame(()=>this.refreshKey++)},onCompositionEnd(){this.isComposing=!1},onScroll(e){var t=this.$refs.textarea,s=this.$refs.highlighter;s.scrollTop=t.scrollTop,s.scrollLeft=t.scrollLeft},showMentions(e){this.mentions.caretOffset=e,this.mentions.show=!0,this.mentions.list=[],this.repositionDropdown(),window.addEventListener("resize",()=>this.hideMentions(),{once:!0})},repositionDropdown(){this.mentions.show&&this.$nextTick(()=>{var e,t,s=this.getCaretPosition(this.mentions.caretOffset);null!==s&&(this.mentions.style.top=s.top+s.height+5+"px",e=this.$refs.mentions.offsetWidth,t=window.innerWidth,s.left+e>t?this.mentions.style.left=t-e+"px":this.mentions.style.left=s.left+"px")})},getCaretPosition(r){var e=this.$refs.highlighter;let a=0,l=t=>{for(let e=0;e<t.childNodes.length;e++){var s=t.childNodes[e];if(s.nodeType===Node.TEXT_NODE){var i,n=s.textContent.length;if(a+n>=r)return i=r-a,i=s.splitText(i),(o=document.createElement("span")).classList.add("hl-caret"),t.insertBefore(o,i),i=o.getBoundingClientRect(),o.remove(),{top:window.pageYOffset+i.top,left:window.pageXOffset+i.left,width:i.width,height:i.height};a+=n}else if(s.nodeType===Node.ELEMENT_NODE){var o=l(s);if(null!==o)return o}}return null};return l(e)},hideMentions(){this.mentions.show=!1},onKeydown(e){this.$refs.textarea,this.mentions.show&&("ArrowDown"===e.key?(e.preventDefault(),this.mentions.focused=Math.min(this.mentions.focused+1,this.mentions.list.length-1)):"ArrowUp"===e.key?(e.preventDefault(),this.mentions.focused=Math.max(this.mentions.focused-1,0)):"Enter"===e.key?(e.preventDefault(),this.$refs.mentions.querySelector("a.is-active")?.click()):"Escape"===e.key&&this.hideMentions()),"Tab"===e.key&&(e.preventDefault(),this.insertText("\t"))},selectMention(e){var{startIndex:t,endIndex:s}=this.mentions.query,i=this.$refs.textarea;i.focus(),i.setSelectionRange(t,s),document.execCommand("insertText",!1,e.username.replaceAll(" ","路")),this.hideMentions()},insertText(e){document.activeElement!==this.$refs.textarea&&this.$refs.textarea.focus(),document.execCommand("insertText",!1,e)},focus(){var e=this.$refs.textarea;e&&e.focus()}},computed:{highlightedContent(){this.refreshKey;let t=this.data.content,s=(this.isComposing&&this.$refs.textarea&&(t=this.$refs.textarea.value),t=this.$root.escapeHTML(t),[]),i=e=>{var t=` {${Voxel.helpers.randomId(32)}} `;return s.push({id:t,content:e}),t};return t=(t=(t=(t=(t=t.replace(this.$root.RG_CODE_BLOCK,e=>i(e))).replace(this.$root.RG_INLINE_CODE,e=>i(e))).replace(this.$root.RG_USERNAME,(e,t,s)=>(s=s.replaceAll("路",'<span style="opacity:.3;">路</span>'),i(t+`<a href="#">${s}</a>`)))).replace(this.$root.RG_HASHTAG,(e,t,s)=>i(t+`<a href="#">${s}</a>`))).replace(this.$root.RG_REGULAR_LINK,t=>{try{new URL(t);return`<a href="#">${t}</a>`}catch(e){return t}}),s.forEach(e=>{t=t.replace(e.id,e.content)}),"\n"===t.at(-1)&&(t+=" "),t}}},Review_Score={template:"#vxfeed__review-score",emits:["update:modelValue"],props:{config:Object,modelValue:Object},data(){return{rating:this.modelValue}},methods:{setScore(e,t){this.isScoreSelected(e,t)?delete this.rating[e.key]:this.rating[e.key]=t.score},isScoreSelected(e,t){return this.rating[e.key]===t.score},isScoreCovered(e,t){e=this.rating[e.key];return"number"==typeof e&&e>=t.score},getActiveScore(e){e=this.rating[e.key];return[-2,-1,0,1,2].includes(e)?this.config.rating_levels[e+2]:null}},watch:{modelValue(e){this.rating=e}}},timelineComposer={template:"#vxfeed__composer",mixins:[Composer_Mixin],emits:["publish","update","cancel","mounted"],props:{status:{type:Object,default:null},quoteOf:{type:Object,default:null}},components:{"review-score":Review_Score},data(){return{submitting:!1,data:{content:"",files:[],rating:{}},isDragOver:!1}},created(){this.config=this.$root.config.composer,this.settings=this.$root.config.settings.posts,null!==this.status&&(this.data.content=this.status.content,this.data.files=structuredClone(Vue.toRaw(this.status.files)),"post_reviews"===this.status.feed)&&this.status.review&&(this.data.rating=structuredClone(Vue.toRaw(this.status.review.rating))),document.dispatchEvent(new CustomEvent("voxel/timeline/composer/init",{detail:{composer:this}}))},mounted(){this.$nextTick(()=>this.$emit("mounted"))},methods:{onCancel(){this.status?this.status.content!==this.data.content?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel"):this.data.content.length||this.data.files.length?Voxel.prompt(this.$root.config.l10n.cancelEdit,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>this.$emit("cancel")},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):this.$emit("cancel")},publish(){if(null!==this.status){this.submitting=!0;let t=new FormData,s=(this.$root.config,{status_id:this.status.id,content:this.data.content,files:[],rating:this.data.rating});this.data.files.forEach(e=>{"new_upload"===e.source?(t.append("files[timeline][]",e.item),s.files.push("uploaded_file")):"existing"===e.source&&s.files.push(e.id)}),t.append("data",JSON.stringify(s)),t.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.edit",data:t,contentType:!1,processData:!1}).always(e=>{this.submitting=!1,e.success?(Voxel.alert(e.message,"success",null,3e3),this.$emit("update",e.status)):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}else if(null!==this.quoteOf){this.submitting=!0;let t=new FormData,s=(this.$root.config,{status_id:this.quoteOf.id,content:this.data.content,files:[]});this.data.files.forEach(e=>{"new_upload"===e.source?(t.append("files[timeline][]",e.item),s.files.push("uploaded_file")):"existing"===e.source&&s.files.push(e.id)}),t.append("data",JSON.stringify(s)),t.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.quote",data:t,contentType:!1,processData:!1}).always(e=>{this.submitting=!1,e.success?(Voxel.alert(e.message,"success",null,3e3),this.$emit("publish",e.status),this.reset()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}else{this.submitting=!0;let t=new FormData;var e=this.$root.config;let s={feed:e.composer.feed,post_id:e.current_post.id,content:this.data.content,files:[],rating:this.data.rating};this.data.files.forEach(e=>{"new_upload"===e.source?(t.append("files[timeline][]",e.item),s.files.push("uploaded_file")):"existing"===e.source&&s.files.push(e.id)}),t.append("data",JSON.stringify(s)),t.append("_wpnonce",this.$root.config.nonce),jQuery.post({url:Voxel_Config.ajax_url+"&action=timeline/v2/status.publish",data:t,contentType:!1,processData:!1}).always(e=>{this.submitting=!1,e.success?(this.$emit("publish",e.status),this.reset()):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})}},reset(){this.data.content="",this.data.files=[],this.data.rating={}},onDragEnter(e){e.dataTransfer?.types?.includes("Files")&&this.settings.gallery_enabled&&(this.isDragOver=!0,this.isFocused=!0)},onDrop(e){this.isDragOver=!1,this.$refs.mediaUploader.onDrop(e)}},computed:{placeholder(){return(this.quoteOf?this.$root.config.settings.quotes:this.config).placeholder},avatarUrl(){var e=this.$root.config;return("current_user"===e.composer.post_as?e.current_user:e.current_post).avatar_url},isExpanded(){return!!(this.status||this.quoteOf||this.isFocused||this.data.content.length||this.data.files.length||"post_reviews"===this.config.feed&&Object.values(this.data.rating).some(e=>"number"==typeof e))},reviewConfig(){var e;return!this.quoteOf&&(!this.status||"post_reviews"===this.status.feed)&&(this.status||"post_reviews"===this.config.feed)?(e=this.$root.config.reviews,this.status&&this.status.review?e[this.status.review.post_type]:e[this.config.reviews_post_type]):null}}};export{timelineComposer as default};
