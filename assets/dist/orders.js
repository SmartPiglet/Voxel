(e=>{"function"==typeof define&&define.amd?define("orders",e):e()})(function(){var e={template:"#order-item-promotion-details",props:{item:Object,order:Object,parent:Object},data(){return{}},methods:{cancelPromotion(){confirm(Voxel_Config.l10n.confirmAction)&&(this.parent.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.promotions.cancel_promotion",{order_id:this.order.id,_wpnonce:this.parent.orders.config.nonce}).always(e=>{this.parent.running_action=!1,e.success||Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.parent.reload()}))}},computed:{details(){return this.item.details.promotion_package},hasDates(){return this.details.start_date&&this.details.end_date},getDates(){return this.details.start_date+" - "+this.details.end_date}}},i={template:"#orders-single",props:{order:Object,orders:Object},components:{itemPromotionDetails:e},data(){return{running_action:!1}},created(){this.setupComponents(this.order)},mounted(){window.scrollTo(0,0)},methods:{reload(){this.orders.reloadOrder(this.order.id,e=>{this.setupComponents(e.order)})},setupComponents(e){let r=this.$.appContext;Object.values(e.components).forEach(e=>{var t="order:"+e.type;r.components[t]||r.app.component(t,Vue.defineAsyncComponent(()=>import(e.src).then(e=>e.default)))}),e.items.forEach(e=>{Object.values(e.components).forEach(e=>{var t="order-item:"+e.type;r.components[t]||r.app.component(t,Vue.defineAsyncComponent(()=>import(e.src).then(e=>e.default)))})})},goBack(){this.orders.order.id=null,this.orders.order.item=null,Voxel.deleteSearchParam("order_id"),Voxel.getSearchParam("parent_id")?this.$root.viewOrder(Voxel.getSearchParam("parent_id")):this.orders.query.is_initial_load&&this.orders.getInitialOrders()},replace_vars(t,r){return Object.keys(r).forEach(e=>{t=t.replaceAll(e,r[e])}),t},openConversation(){var e;this.isVendor()?((e=new URL(this.orders.config.messages.url)).searchParams.set("chat","u"+this.order.customer.id),e.searchParams.set("text",this.replace_vars(this.orders.config.messages.enquiry_text.vendor,{"@order_id":this.order.id})),window.location.href=e.toString()):((e=new URL(this.orders.config.messages.url)).searchParams.set("chat",this.order.actions.dms.vendor_target),e.searchParams.set("text",this.replace_vars(this.orders.config.messages.enquiry_text.customer,{"@order_id":this.order.id})),window.location.href=e.toString())},isVendor(){return this.order.current_user.id===this.order.vendor.id},isCustomer(){return this.order.current_user.id===this.order.customer.id},isAdmin(){return this.order.current_user.is_admin},getAction(e){for(var t of this.order.actions.primary)if(t.action===e)return t;for(var r of this.order.actions.secondary)if(r.action===e)return r;return null},runAction(e){let t=()=>{this.running_action=!0,jQuery.post(Voxel_Config.ajax_url+"&action=products.single_order.run_action",{order_id:this.order.id,_wpnonce:this.orders.config.nonce,order_action:e.action}).always(e=>{this.running_action=!1,e.success?e.redirect_to?window.location.href=e.redirect_to:this.reload():(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),this.reload())}),this.$refs.actions?.blur()};"string"==typeof e.confirm?Voxel.prompt(e.confirm||Voxel_Config.l10n.confirmAction,"warning",[{label:Voxel_Config.l10n.yes,onClick:()=>t()},{label:Voxel_Config.l10n.no,onClick:()=>{}}],7500):t()},truncate(e){var t=document.createElement("div");t.innerHTML=e;let r=this.orders.config.data_inputs.content_length,s=!1,i=0,o=e=>{var t;s?e.remove():(t=Array.from(e.childNodes)).length?t.forEach(e=>o(e)):(i+=e.textContent.length)>=r&&(s=!0,i>r&&(e.textContent=e.textContent.slice(0,-(i-r))),e.textContent+="â€¦")};return o(t),{content:t.innerHTML,exists:s}}},computed:{dataInputs(){let s={};return this.order.items.forEach(e=>{var t=e.data_inputs_markup,r=this.truncate(t);s[e.id]={content:t,truncated:r}}),s}}},a={template:"#vx-file-upload",props:{field:Object,sortable:{type:Boolean,default:!0},allowedFileTypes:String,maxFileCount:{type:Number,default:1},modelValue:Array,context:Object},emits:["update:modelValue"],data(){return{dragActive:!1,reordering:!1,value:this.modelValue,id:"file-upload-"+Voxel.helpers.sequentialId()}},mounted(){jQuery(this.$refs.input).on("change",e=>{for(var t=0;t<e.target.files.length;t++){var r=e.target.files[t];this.pushFile(r)}this.$refs.input.value="",this.update()})},unmounted(){setTimeout(()=>{Array.isArray(this.value)&&this.value.forEach(e=>{"new_upload"===e.source&&URL.revokeObjectURL(e.preview)})},10)},methods:{getStyle(e){return e.type.startsWith("image/")?`background-image: url('${e.preview}');`:""},pushFile(t){1===this.maxFileCount&&(this.value=[]);var e={source:"new_upload",name:t.name,type:t.type,size:t.size,preview:URL.createObjectURL(t),item:t,_id:Voxel.helpers.randomId(8)},r=(void 0===window._vx_file_upload_cache&&(window._vx_file_upload_cache=[]),window._vx_file_upload_cache.find(e=>e.item.name===t.name&&e.item.type===t.type&&e.item.size===t.size&&e.item.lastModified===t.lastModified));r?this.value.push(r):(this.value.push(e),window._vx_file_upload_cache.unshift(e))},onDrop(e){this.dragActive=!1,e.dataTransfer.items?[...e.dataTransfer.items].forEach(e=>{"file"===e.kind&&this.pushFile(e.getAsFile())}):[...e.dataTransfer.files].forEach(e=>{this.pushFile(e)}),this.update()},onMediaPopupSave(e){1===this.maxFileCount&&(this.value=[]);var t={};this.value.forEach(e=>{"existing"===e.source&&(t[e.id]=!0),"new_upload"===e.source&&(t[e._id]=!0)}),Object.values(e).forEach(e=>{"existing"!==e.source||t[e.id]||this.value.push(e),"new_upload"!==e.source||t[e._id]||this.value.push(e)}),this.update()},update(){this.$emit("update:modelValue",this.value)}},watch:{modelValue(e){this.value=e}}};window.render_orders=()=>{Array.from(document.querySelectorAll(".vx-orders-widget")).forEach(e=>{if(!e.__vue_app__){var o,s=JSON.parse(e.dataset.config);let t=JSON.parse(e.closest(".elementor-element").querySelector(".vxconfig__icons").innerHTML),r=(o=s,Vue.createApp({el:e,mixins:[Voxel.mixins.base],data(){return{config:o,activePopup:null,query:{is_initial_load:!0,pg:1,status:"all",shipping_status:"all",product_type:"all",search:"",loading:!0,has_more:!1,items:[]},order:{id:null,loading:!1,item:null}}},created(){window.VX_Orders=this;var e=parseInt(Voxel.getSearchParam("order_id"),10);!isNaN(e)&&0<e?this.viewOrder(e):this.getInitialOrders()},methods:{getInitialOrders(){var e=parseInt(Voxel.getSearchParam("pg"),10),t=Voxel.getSearchParam("status"),r=Voxel.getSearchParam("shipping_status"),s=Voxel.getSearchParam("product_type"),i=Voxel.getSearchParam("search");1<e&&(this.query.pg=e),"string"==typeof t&&o.statuses[t]&&(this.query.status=t),"string"==typeof r&&o.shipping_statuses[r]&&(this.query.shipping_status=r),"string"==typeof s&&o.product_types[s]&&(this.query.product_type=s),"string"==typeof i&&i.trim().length&&(this.query.search=i.trim()),this.getOrders()},getOrders(){1<this.query.pg?Voxel.setSearchParam("pg",this.query.pg):Voxel.deleteSearchParam("pg"),"all"!==this.query.status?Voxel.setSearchParam("status",this.query.status):Voxel.deleteSearchParam("status"),"all"!==this.query.shipping_status?Voxel.setSearchParam("shipping_status",this.query.shipping_status):Voxel.deleteSearchParam("shipping_status"),"all"!==this.query.product_type?Voxel.setSearchParam("product_type",this.query.product_type):Voxel.deleteSearchParam("product_type"),this.query.search?.length?Voxel.setSearchParam("search",this.query.search):Voxel.deleteSearchParam("search"),this.query.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.orders.list",{pg:this.query.pg,status:this.query.status,shipping_status:this.query.shipping_status,product_type:this.query.product_type,search:this.query.search}).always(e=>{this.query.loading=!1,this.query.is_initial_load=!1,e.success?(this.query.items=e.items,this.query.has_more=e.has_more):Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error")})},nextPage(){this.query.pg+=1,this.getOrders()},previousPage(){--this.query.pg,this.query.pg<1&&(this.query.pg=1),this.getOrders()},setStatus(e){this.query.status!==e&&(this.query.status=e,this.query.pg=1,this.getOrders())},setShippingStatus(e){this.query.shipping_status!==e&&(this.query.shipping_status=e,this.query.pg=1,this.getOrders())},setProductType(e){this.query.product_type!==e&&(this.query.product_type=e,this.query.pg=1,this.getOrders())},setSearch(e){this.query.search!==e&&(this.query.search=e,this.query.pg=1,this.getOrders())},resetFilters(){""===this.query.search&&"all"===this.query.status&&"all"===this.query.shipping_status&&"all"===this.query.product_type&&1===this.query.pg||(this.query.search="",this.query.status="all",this.query.shipping_status="all",this.query.product_type="all",this.query.pg=1,this.getOrders())},currencyFormat(){return Voxel.helpers.currencyFormat(...arguments)},viewOrder(e,t=null){this.order.id=e,this.order.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.single_order.get",{order_id:this.order.id}).always(e=>{this.order.loading=!1,e.success?(this.order.item=e.order,Voxel.setSearchParam("order_id",e.order.id),Voxel.deleteSearchParam("parent_id"),null!==t&&Voxel.setSearchParam("parent_id",t)):(Voxel.alert(e.message||Voxel_Config.l10n.ajaxError,"error"),Voxel.deleteSearchParam("order_id"),Voxel.deleteSearchParam("parent_id"),this.order.id=null,this.order.item=null,this.order.loading=!1,this.getInitialOrders())})},reloadOrder(e,r=null){this.order.id=e,this.order.loading=!0,jQuery.get(Voxel_Config.ajax_url+"&action=products.single_order.get",{order_id:this.order.id}).always(t=>{this.order.loading=!1,t.success?this.$nextTick(()=>{this.order.item=t.order;var e=this.query.items.find(e=>e.id===t.order.id);e&&(e.status=t.order.status.key,e.shipping_status=t.order.shipping.status?.key||null),"function"==typeof r&&r(t)}):Voxel.alert(t.message||Voxel_Config.l10n.ajaxError,"error")})}},computed:{$w(){return window}}}));r.component("form-popup",Voxel.components.popup),r.component("form-group",Voxel.components.formGroup),r.component("single-order",i),a.template="#vx-orders-file-upload",r.component("file-upload",a),Object.keys(t).forEach(e=>{r.component("icon-"+e,{template:t[e]||"\x3c!-- icon --\x3e"})}),r.mount(e)}})},window.render_orders(),jQuery(document).on("voxel:markup-update",window.render_orders)});
